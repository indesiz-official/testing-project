<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PayNow 付款 - Indesiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background-color: #f2f4f8;
    }

    .payment-card {
      max-width: 600px;
      margin: 3rem auto;
      padding: 2.5rem 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      background-color: #fff;
      text-align: center;
    }

    .payment-card h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .payment-card h1 i {
      margin-right: 0.5rem;
      color: #0d6efd;
    }

    .qr-container {
      margin: 2rem 0;
    }

    .qr-container img {
      max-width: 350px;
      width: 100%;
      height: auto;
      border: 2px solid #0d6efd;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #fff;
    }

    .btn-pay {
      font-size: 1.3rem;
      padding: 0.85rem;
    }

    /* 右上角圆形倒计时 */
    .timer-circle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      z-index: 9999;
      background-color: rgba(255,255,255,0.9);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      pointer-events: none;
    }

    .timer-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .timer-circle circle {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
    }

    .timer-bg {
      stroke: #e6e6e6;
    }

    .timer-progress {
      stroke: #28a745;
      transition: stroke 0.3s;
      stroke-dasharray: 314; /* 2 * pi * 50 */
      stroke-dashoffset: 0;
    }

    .timer-text {
      position: relative;
      font-size: 1.3rem;
      font-weight: bold;
      color: #333;
      z-index: 1;
    }

  </style>
</head>
<body>

<div class="payment-card">
  <h1>
    <i class="fa-solid"></i>
    PayNow QR 付款
  </h1>

  <p class="fs-5">订单总额: <span class="fw-bold text-success">$<%= grandTotal.toFixed(2) %></span></p>

  <div class="qr-container">
    <img src="/images/sgqr.jpg" alt="SGQR Code">
  </div>

  <p class="text-muted mb-4">📌 请打开您的银行 / PayNow App，扫描二维码完成付款</p>

  <form action="/order-confirm" method="POST">
    <button id="payButton" type="submit" class="btn btn-success btn-pay w-100">✅ 我已完成付款</button>
  </form>
</div>

<!-- 右上角圆形倒计时 -->
<div class="timer-circle">
  <svg>
    <circle class="timer-bg" cx="60" cy="60" r="50"></circle>
    <circle class="timer-progress" cx="60" cy="60" r="50"></circle>
  </svg>
  <div class="timer-text" id="countdown">10:00</div>
</div>

<script>
  const countdownEl = document.getElementById('countdown');
  const payButton = document.getElementById('payButton');
  const progressCircle = document.querySelector('.timer-progress');

  let timeLeft = 10 * 60; // 秒
  const totalTime = timeLeft;
  const radius = 50;
  const circumference = 2 * Math.PI * radius;

  progressCircle.style.strokeDasharray = circumference;
  progressCircle.style.strokeDashoffset = 0;

  const timer = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    countdownEl.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

    // 更新圆形进度
    const offset = circumference * (1 - timeLeft / totalTime);
    progressCircle.style.strokeDashoffset = offset;

    // 剩余1分钟变橙色
    if (timeLeft <= 60 && timeLeft > 0) {
      progressCircle.style.stroke = '#ff8800';
    }

    // 时间到，闪红色
    if (timeLeft <= 0) {
      clearInterval(timer);
      countdownEl.textContent = "00:00";
      payButton.disabled = true;

      let flash = true;
      const flashTimer = setInterval(() => {
        progressCircle.style.stroke = flash ? '#ff0000' : '#800000';
        flash = !flash;
      }, 500);

      alert('⛔ 付款超时，请重新下单');
      window.location.href = '/checkout';
    }

    timeLeft--;
  }, 1000);
</script>

</body>
</html>
